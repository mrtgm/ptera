name: "Deploy Application"

on:
  push:
    branches:
      - main
      - devel

permissions:
  id-token: write
  contents: read

# この辺っていい感じにやる方法ないのか・・・
#（個人のプライベートリポジトリだと ENVIRONMENTS 使えない）
env:
  AWS_REGION: ap-northeast-1
  AWS_ROLE: ${{ github.ref == 'refs/heads/main' && secrets.AWS_ROLE_PROD || secrets.AWS_ROLE_DEV }}

jobs:
  filter:
    name: "Filter Changed Files"
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect File Changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'

  validate:
    name: "Type Check"
    runs-on: ubuntu-latest
    needs: filter
    # if: ${{ needs.filter.outputs.frontend == 'true' || needs.filter.outputs.backend == 'true' }}

    steps:
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Use Cached node_modules
        uses: actions/cache@v4
        with:
          path: |
            frontend/node_modules
            backend/node_modules
          key: node-modules-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            node-modules-

      # TODO: Turborepo など、モノレポツールの導入
      - name: Install Dependencies
        run: |
          if [ -d "frontend" ]; then
            cd frontend
            bun install
            cd ..
          fi

          if [ -d "backend" ]; then
            cd backend
            bun install
            cd ..
          fi

      - name: Run Type Check
        run: |
          if [ -d "frontend" ]; then
            cd frontend
            bun run typecheck || echo "Frontend type check failed"
            cd ..
          fi

          if [ -d "backend" ]; then
            cd backend
            bun run typecheck || echo "Backend type check failed"
            cd ..
          fi

  deploy-backend:
    name: "Deploy Backend"
    runs-on: ubuntu-latest
    needs: [filter, validate]
    # if: ${{ needs.filter.outputs.backend == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          aws-region: ap-northeast-1

      # バックエンド（Lambda関数）をビルドしてデプロイ
      - name: Install Backend Dependencies
        run: |
          cd backend
          bun install --frozen-lockfile

      - name: Build Backend
        run: |
          cd backend
          bun run build

      - name: Package Lambda Function
        run: |
          cd backend
          bun run zip

      - name: Deploy Lambda Function
        run: |
          aws lambda update-function-code \
            --function-name ptera-api-${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }} \
            --zip-file fileb://backend/lambda.zip

  deploy-frontend:
    name: "Deploy Frontend"
    runs-on: ubuntu-latest
    needs: [filter, validate]
    # if: ${{ needs.filter.outputs.frontend == 'true' }}

    env:
      SUFFIX: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          aws-region: ap-northeast-1

      # フロントエンド（SPA）をビルドしてデプロイ
      - name: Install Frontend Dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile

      - name: Build Frontend
        run: |
          cd frontend
          export VITE_API_URL=${{ github.ref == 'refs/heads/main' && 'https://ptera.morio.space/api' || 'https://dev.ptera.morio.space/api' }}
          bun run build

      # index.htmlは別々にデプロイ
      - name: Deploy Frontend to S3
        run: |
          aws s3 sync frontend/build/client/ s3://ptera-spa-${{ env.SUFFIX  }} \
            --delete \
            --cache-control "max-age=31536000,public" \
            --exclude "index.html"
          aws s3 cp frontend/build/client/index.html s3://ptera-spa-${{ env.SUFFIX }}/index.html \
            --cache-control "max-age=0,no-cache,no-store,must-revalidate" \
            --content-type "text/html; charset=utf-8"

      # CloudFrontのキャッシュを無効化
      # https://zenn.dev/keita_hino/articles/2a129d442daf05
      - name: Get CloudFront Distribution ID
        id: get-distribution-id
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Aliases.Items[?contains(@, '${{ github.ref == 'refs/heads/main' && 'ptera.morio.space' || 'dev.ptera.morio.space' }}')]].Id" \
            --output text)
          echo "DISTRIBUTION_ID=$DISTRIBUTION_ID" >> $GITHUB_ENV

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ env.DISTRIBUTION_ID }} \
            --paths "/*"
